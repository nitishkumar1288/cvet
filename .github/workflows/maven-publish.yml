name: Maven Package

on:
  push:
    branches: [test,main]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          ref: test

      - name: Run build plugin jar
        working-directory: covetrus-project/cvet
        run: |
          mvn -B clean install -DskipTests
          mkdir -p ${CI_PROJECT_DIR}/artifacts
          cp target/*.jar ${CI_PROJECT_DIR}/artifacts
          ls -lah ${CI_PROJECT_DIR}/artifacts

      - name: Run the deploy
        if: ${{ github.ref == 'refs/heads/test' }}
        run: |
          chmod +x ./covetrus-project/cvet/deployment/retailer1/rubix-install.sh
          ./covetrus-project/cvet/deployment/retailer1/rubix-install.sh
          
        env:
          API_HOST: ${{ vars.DEV_API_HOST }}
          DEV_ACCOUNT: ${{ vars.DEV_ACCOUNT }}
          RETAILER_PASSWORD: ${{ secrets.DEV_RETAILER_PASSWORD }}
          PLUGIN_NAME: ${{ vars.DEV_PLUGIN_NAMESPACE }}
          RETAILER_USERNAME: ${{ vars.DEV_RETAILER_USERNAME }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
          GIT_EMAIL: ${{ vars.GLOBAL_GIT_EMAIL_ID }}
          GIT_USERNAME: ${{ vars.GLOBAL_GIT_USER_NAME }}
          GIT_ACCESS_TOKEN: ${{ secrets.DEV_GLOBAL_GIT_ACCESS_TOKEN }}
          GITHUB_TOKEN: ${{ github.token }}
